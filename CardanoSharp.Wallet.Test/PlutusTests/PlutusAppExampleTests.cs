using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using CardanoSharp.Wallet.Enums;
using CardanoSharp.Wallet.Encoding;
using CardanoSharp.Wallet.Extensions;
using CardanoSharp.Wallet.Extensions.Models;
using CardanoSharp.Wallet.Extensions.Models.Transactions;
using CardanoSharp.Wallet.Models;
using CardanoSharp.Wallet.Models.Addresses;
using CardanoSharp.Wallet.Models.Keys;
using CardanoSharp.Wallet.Models.Transactions;
using CardanoSharp.Wallet.Models.Transactions.TransactionWitness.PlutusScripts;
using CardanoSharp.Wallet.TransactionBuilding;
using CardanoSharp.Wallet.Utilities;
using PeterO.Cbor2;
using Xunit;

namespace CardanoSharp.Wallet.Test;

public class PlutusScriptTests
{
    private readonly string stakeScriptCbor =
        "82025907655907620100003232323232323232323232323232332232323232322232325335320193333573466E1CD55CEA80124000466442466002006004646464646464646464646464646666AE68CDC39AAB9D500C480008CCCCCCCCCCCC88888888888848CCCCCCCCCCCC00403403002C02802402001C01801401000C008CD4050054D5D0A80619A80A00A9ABA1500B33501401635742A014666AA030EB9405CD5D0A804999AA80C3AE501735742A01066A02803E6AE85401CCCD54060081D69ABA150063232323333573466E1CD55CEA801240004664424660020060046464646666AE68CDC39AAB9D5002480008CC8848CC00400C008CD40A9D69ABA15002302B357426AE8940088C98C80B4CD5CE01701681589AAB9E5001137540026AE854008C8C8C8CCCD5CD19B8735573AA004900011991091980080180119A8153AD35742A00460566AE84D5D1280111931901699AB9C02E02D02B135573CA00226EA8004D5D09ABA2500223263202933573805405204E26AAE7940044DD50009ABA1500533501475C6AE854010CCD540600708004D5D0A801999AA80C3AE200135742A004603C6AE84D5D1280111931901299AB9C026025023135744A00226AE8940044D5D1280089ABA25001135744A00226AE8940044D5D1280089ABA25001135744A00226AE8940044D55CF280089BAA00135742A004601C6AE84D5D1280111931900B99AB9C018017015101613263201633573892010350543500016135573CA00226EA800448C88C008DD6000990009AA80A911999AAB9F0012500A233500930043574200460066AE880080508C8C8CCCD5CD19B8735573AA004900011991091980080180118061ABA150023005357426AE8940088C98C8050CD5CE00A80A00909AAB9E5001137540024646464646666AE68CDC39AAB9D5004480008CCCC888848CCCC00401401000C008C8C8C8CCCD5CD19B8735573AA0049000119910919800801801180A9ABA1500233500F014357426AE8940088C98C8064CD5CE00D00C80B89AAB9E5001137540026AE854010CCD54021D728039ABA150033232323333573466E1D4005200423212223002004357426AAE79400C8CCCD5CD19B875002480088C84888C004010DD71ABA135573CA00846666AE68CDC3A801A400042444006464C6403666AE7007006C06406005C4D55CEA80089BAA00135742A00466A016EB8D5D09ABA2500223263201533573802C02A02626AE8940044D5D1280089AAB9E500113754002266AA002EB9D6889119118011BAB00132001355012223233335573E0044A010466A00E66442466002006004600C6AAE754008C014D55CF280118021ABA200301213574200222440042442446600200800624464646666AE68CDC3A800A40004642446004006600A6AE84D55CF280191999AB9A3370EA0049001109100091931900819AB9C01101000E00D135573AA00226EA80048C8C8CCCD5CD19B875001480188C848888C010014C01CD5D09AAB9E500323333573466E1D400920042321222230020053009357426AAE7940108CCCD5CD19B875003480088C848888C004014C01CD5D09AAB9E500523333573466E1D40112000232122223003005375C6AE84D55CF280311931900819AB9C01101000E00D00C00B135573AA00226EA80048C8C8CCCD5CD19B8735573AA004900011991091980080180118029ABA15002375A6AE84D5D1280111931900619AB9C00D00C00A135573CA00226EA80048C8CCCD5CD19B8735573AA002900011BAE357426AAE7940088C98C8028CD5CE00580500409BAA001232323232323333573466E1D4005200C21222222200323333573466E1D4009200A21222222200423333573466E1D400D2008233221222222233001009008375C6AE854014DD69ABA135744A00A46666AE68CDC3A8022400C4664424444444660040120106EB8D5D0A8039BAE357426AE89401C8CCCD5CD19B875005480108CC8848888888CC018024020C030D5D0A8049BAE357426AE8940248CCCD5CD19B875006480088C848888888C01C020C034D5D09AAB9E500B23333573466E1D401D2000232122222223005008300E357426AAE7940308C98C804CCD5CE00A00980880800780700680600589AAB9D5004135573CA00626AAE7940084D55CF280089BAA0012323232323333573466E1D400520022333222122333001005004003375A6AE854010DD69ABA15003375A6AE84D5D1280191999AB9A3370EA0049000119091180100198041ABA135573CA00C464C6401866AE700340300280244D55CEA80189ABA25001135573CA00226EA80048C8C8CCCD5CD19B875001480088C8488C00400CDD71ABA135573CA00646666AE68CDC3A8012400046424460040066EB8D5D09AAB9E500423263200933573801401200E00C26AAE7540044DD500089119191999AB9A3370EA00290021091100091999AB9A3370EA00490011190911180180218031ABA135573CA00846666AE68CDC3A801A400042444004464C6401466AE7002C02802001C0184D55CEA80089BAA0012323333573466E1D40052002200723333573466E1D40092000212200123263200633573800E00C00800626AAE74DD5000A4C2400292010350543100122002112323001001223300330020020011";
    private readonly string mintingScriptCbor =
        "5907655907620100003232323232323232323232323232332232323232322232325335320193333573466e1cd55cea80124000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd4050054d5d0a80619a80a00a9aba1500b33501401635742a014666aa030eb9405cd5d0a804999aa80c3ae501735742a01066a02803e6ae85401cccd54060081d69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd40a9d69aba15002302b357426ae8940088c98c80b4cd5ce01701681589aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a8153ad35742a00460566ae84d5d1280111931901699ab9c02e02d02b135573ca00226ea8004d5d09aba2500223263202933573805405204e26aae7940044dd50009aba1500533501475c6ae854010ccd540600708004d5d0a801999aa80c3ae200135742a004603c6ae84d5d1280111931901299ab9c026025023135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a004601c6ae84d5d1280111931900b99ab9c018017015101613263201633573892010350543500016135573ca00226ea800448c88c008dd6000990009aa80a911999aab9f0012500a233500930043574200460066ae880080508c8c8cccd5cd19b8735573aa004900011991091980080180118061aba150023005357426ae8940088c98c8050cd5ce00a80a00909aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa0049000119910919800801801180a9aba1500233500f014357426ae8940088c98c8064cd5ce00d00c80b89aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423212223002004357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6403666ae7007006c06406005c4d55cea80089baa00135742a00466a016eb8d5d09aba2500223263201533573802c02a02626ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab00132001355012223233335573e0044a010466a00e66442466002006004600c6aae754008c014d55cf280118021aba200301213574200222440042442446600200800624464646666ae68cdc3a800a40004642446004006600a6ae84d55cf280191999ab9a3370ea0049001109100091931900819ab9c01101000e00d135573aa00226ea80048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900819ab9c01101000e00d00c00b135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900619ab9c00d00c00a135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c8028cd5ce00580500409baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c804ccd5ce00a00980880800780700680600589aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6401866ae700340300280244d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200933573801401200e00c26aae7540044dd500089119191999ab9a3370ea00290021091100091999ab9a3370ea00490011190911180180218031aba135573ca00846666ae68cdc3a801a400042444004464c6401466ae7002c02802001c0184d55cea80089baa0012323333573466e1d40052002200723333573466e1d40092000212200123263200633573800e00c00800626aae74dd5000a4c2400292010350543100122002112323001001223300330020020011";
    private readonly string redeemerScriptCbor =
        "5908f85908f5010000323233223232323322323232323322323232323232323232323232323232323232323232322223232533532323302132533533029001488100102a102b376600c660426a038666aa03a60462400246664002a04e002605066aa0584002664002a046902a19aa8159aa980d8900099aaa810004004991a80091111111111100628009a80e199aa80e98118900091999000a813800981419aa8161000999000a811a40a866aa0566aa60362400266aaa040010012646a002444444444444016a00226a002440046666ae68cdc39aab9d5002480008cc8848cc00400c008c8c8c8c8c8c8c8c8c8c8c8c8c8cccd5cd19b8735573aa018900011999999999999111111111110919999999999980080680600580500480400380300280200180119a80b80c1aba1500c33501701835742a01666a02e0326ae854028ccd5406dd7280d1aba150093335501b75ca0346ae854020cd405c080d5d0a803999aa80d810bad35742a00c6464646666ae68cdc39aab9d5002480008cc8848cc00400c008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a815bad35742a00460586ae84d5d1280111931901719ab9c02f02e02c135573ca00226ea8004d5d0a8011919191999ab9a3370e6aae754009200023322123300100300233502b75a6ae854008c0b0d5d09aba2500223263202e33573805e05c05826aae7940044dd50009aba135744a004464c6405466ae700ac0a80a04d55cf280089baa00135742a00a66a02eeb8d5d0a802199aa80d80e90009aba150033335501b75c40026ae854008c07cd5d09aba2500223263202633573804e04c04826ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aab9e5001137540026ae854008c03cd5d09aba2500223263201833573803203002c202e264c6402e66ae712410350543500017135573ca00226ea80048d400488880088d40048800448c88c008dd6000990009aa811911999aab9f0012501f233501e30043574200460066ae880080488c8c8cccd5cd19b8735573aa004900011991091980080180118051aba150023005357426ae8940088c98c8048cd5ce00980900809aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa004900011991091980080180118099aba1500233500d012357426ae8940088c98c805ccd5ce00c00b80a89aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423025357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6403266ae7006806405c0580544d55cea80089baa00135742a00466a012eb8d5d09aba2500223263201333573802802602226ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab00132001355020223233335573e0044a03a466a03866442466002006004600c6aae754008c014d55cf280118021aba200301013574200224464646666ae68cdc3a800a400046a02a600a6ae84d55cf280191999ab9a3370ea00490011280a91931900819ab9c01101000e00d135573aa00226ea80048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900819ab9c01101000e00d00c00b135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900619ab9c00d00c00a135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c8028cd5ce00580500409baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c804ccd5ce00a00980880800780700680600589aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6401866ae700340300280244d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200933573801401200e00c26aae7540044dd500089119191999ab9a3370ea00290021091100091999ab9a3370ea00490011190911180180218031aba135573ca00846666ae68cdc3a801a400042444004464c6401466ae7002c02802001c0184d55cea80089baa0012323333573466e1d40052002201623333573466e1d40092000201623263200633573800e00c00800626aae74dd5000a4c2400292103505431003200135501122112253350011500e22133500f3004002335530061200100400112533500121010100e11222333550033212330012253350022100310010025004253353003001135006001150050011212230020031122001111222300330020012253350021001100a123750002640026aa0124422444a66a00226a00644002442666a00a440046008004666aa600e2400200a008002224400424424466002008006244a666a0042a666a002200c4200c4200c42a666a004200c42666ae68cdd78010008040039080390a999a801080310803909980300100090911180100211199ab9a3371e00400200800624400424400222446004002224646002002446600660040040021";
    private readonly string skey =
        "addr_xsk17pl7n8yk2guhnt4suk2ry47kvu6jrumgq99nhyy8x82c4nukjdpcdzz867p3rem6j938l8qz3w5v7scqekkvr2crl0q8p8a8mhy6c2wjl88r9yp8tra2e9latzr5cevdhkd7vyj02l98r8ef4zguunan8qndjxe3";
    private readonly string vkey = "addr_xvk1pu6ws8n0lncpk9p43kk4dpnv6chfy5f469hezk6q4yekjgpvr79d97wwx2gzwk864jtl6ky8f3jcm0vmucfy7472wx0jn2y3ee8mxwq2yh9x5";

    private readonly string utxoAddress = "addr_test1vp7yptd2khhc0jf2vspj40ul6kgkff3wx7hdrhuqejjlfzquzf422";
    private readonly string readonlyAddress = "addr_test1wzwga8d8lq0re2gysheja0hunqfhezkzvzs89gqvf2h3gtgtsq54j";
    private readonly string plutusSpendingScriptAddress = "addr_test1wpqncgrlecd63sg8zavxw5va82xv7w9fg68k7g4zyxt52dgqzuwj8";
    private readonly string dummyAddress1 = "addr_test1vzy9d4w4n0k23hgjxctf8v9vjdmwxh5nal4cwudadztdksg3fs5d9";
    private readonly string mintingRefScriptAddress = "addr_test1wzwga8d8lq0re2gysheja0hunqfhezkzvzs89gqvf2h3gtgtsq54j";
    private readonly string createTxHash = "a8d2cd792a5d2f76666e748b0842bcdb518e47326f947c06fe6d71738da2f74c";
    private readonly uint createTxIndex = 0;
    private readonly int fee = 442701;
    private readonly long lovelace1 = 10000000;
    private readonly long lovelace2 = 10835340;
    private readonly string datum = "{\"int\":42}";


    // Here are the cardano-cli commands that represents the control
    //
    // cardano-cli transaction build \
    // --babbage-era \
    // --cardano-mode \
    // --testnet-magic 1 \
    // --change-address "addr_test1vp7yptd2khhc0jf2vspj40ul6kgkff3wx7hdrhuqejjlfzquzf422" \
    // --tx-in "a8d2cd792a5d2f76666e748b0842bcdb518e47326f947c06fe6d71738da2f74c#0" \
    // --tx-out "addr_test1wzwga8d8lq0re2gysheja0hunqfhezkzvzs89gqvf2h3gtgtsq54j+10000000" \
    // --tx-out-reference-script-file "stake-script.plutus" \
    // --tx-out-inline-datum-file "42.datum" \
    // --tx-out "addr_test1vp7yptd2khhc0jf2vspj40ul6kgkff3wx7hdrhuqejjlfzquzf422+10000000" \
    // --tx-out "addr_test1wpqncgrlecd63sg8zavxw5va82xv7w9fg68k7g4zyxt52dgqzuwj8+10000000" \
    // --tx-out-inline-datum-file "42.datum" \
    // --tx-out "addr_test1vzy9d4w4n0k23hgjxctf8v9vjdmwxh5nal4cwudadztdksg3fs5d9+10835340" \
    // --tx-out-reference-script-file "required-redeemer.plutus" \
    // --tx-out "addr_test1wzwga8d8lq0re2gysheja0hunqfhezkzvzs89gqvf2h3gtgtsq54j+10000000" \
    // --tx-out-reference-script-file "minting-script.plutus" \
    // --protocol-params-file "pparams.json" \
    // --out-file "create-datum-output2.body"
    //
    //
    // cardano-cli transaction sign \
    // --tx-body-file create-datum-output2.body \
    // --testnet-magic 1 \
    // --signing-key-file sKey.prv \
    // --out-file signed-datum-output2.tx

    [Fact]
    public void CreateReferenceScriptTest1()
    {
        // expectedSignTxCbor has a map type { 0: "", 1: "" } for a transaction output. Other libraries still use the array type for legacy outputs so the library has been updated to use those
        //arrange
        // var expectedSignedTxCbor =
        //     "84a30081825820a8d2cd792a5d2f76666e748b0842bcdb518e47326f947c06fe6d71738da2f74c000186a200581d607c40adaab5ef87c92a64032abf9fd59164a62e37aed1df80cca5f488011a336cca37a400581d709c8e9da7f81e3ca90485f32ebefc98137c8ac260a072a00c4aaf142d011a00989680028201d81842182a03d81859076a82025907655907620100003232323232323232323232323232332232323232322232325335320193333573466e1cd55cea80124000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd4050054d5d0a80619a80a00a9aba1500b33501401635742a014666aa030eb9405cd5d0a804999aa80c3ae501735742a01066a02803e6ae85401cccd54060081d69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd40a9d69aba15002302b357426ae8940088c98c80b4cd5ce01701681589aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a8153ad35742a00460566ae84d5d1280111931901699ab9c02e02d02b135573ca00226ea8004d5d09aba2500223263202933573805405204e26aae7940044dd50009aba1500533501475c6ae854010ccd540600708004d5d0a801999aa80c3ae200135742a004603c6ae84d5d1280111931901299ab9c026025023135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a004601c6ae84d5d1280111931900b99ab9c018017015101613263201633573892010350543500016135573ca00226ea800448c88c008dd6000990009aa80a911999aab9f0012500a233500930043574200460066ae880080508c8c8cccd5cd19b8735573aa004900011991091980080180118061aba150023005357426ae8940088c98c8050cd5ce00a80a00909aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa0049000119910919800801801180a9aba1500233500f014357426ae8940088c98c8064cd5ce00d00c80b89aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423212223002004357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6403666ae7007006c06406005c4d55cea80089baa00135742a00466a016eb8d5d09aba2500223263201533573802c02a02626ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab00132001355012223233335573e0044a010466a00e66442466002006004600c6aae754008c014d55cf280118021aba200301213574200222440042442446600200800624464646666ae68cdc3a800a40004642446004006600a6ae84d55cf280191999ab9a3370ea0049001109100091931900819ab9c01101000e00d135573aa00226ea80048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900819ab9c01101000e00d00c00b135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900619ab9c00d00c00a135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c8028cd5ce00580500409baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c804ccd5ce00a00980880800780700680600589aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6401866ae700340300280244d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200933573801401200e00c26aae7540044dd500089119191999ab9a3370ea00290021091100091999ab9a3370ea00490011190911180180218031aba135573ca00846666ae68cdc3a801a400042444004464c6401466ae7002c02802001c0184d55cea80089baa0012323333573466e1d40052002200723333573466e1d40092000212200123263200633573800e00c00800626aae74dd5000a4c2400292010350543100122002112323001001223300330020020011a200581d607c40adaab5ef87c92a64032abf9fd59164a62e37aed1df80cca5f488011a00989680a300581d70413c207fce1ba8c107175867519d3a8ccf38a9468f6f22a221974535011a00989680028201d81842182aa300581d608856d5d59beca8dd12361693b0ac9376e35e93efeb8771bd6896db41011a00a5558c03d8185908fd82025908f85908f5010000323233223232323322323232323322323232323232323232323232323232323232323232322223232533532323302132533533029001488100102a102b376600c660426a038666aa03a60462400246664002a04e002605066aa0584002664002a046902a19aa8159aa980d8900099aaa810004004991a80091111111111100628009a80e199aa80e98118900091999000a813800981419aa8161000999000a811a40a866aa0566aa60362400266aaa040010012646a002444444444444016a00226a002440046666ae68cdc39aab9d5002480008cc8848cc00400c008c8c8c8c8c8c8c8c8c8c8c8c8c8cccd5cd19b8735573aa018900011999999999999111111111110919999999999980080680600580500480400380300280200180119a80b80c1aba1500c33501701835742a01666a02e0326ae854028ccd5406dd7280d1aba150093335501b75ca0346ae854020cd405c080d5d0a803999aa80d810bad35742a00c6464646666ae68cdc39aab9d5002480008cc8848cc00400c008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a815bad35742a00460586ae84d5d1280111931901719ab9c02f02e02c135573ca00226ea8004d5d0a8011919191999ab9a3370e6aae754009200023322123300100300233502b75a6ae854008c0b0d5d09aba2500223263202e33573805e05c05826aae7940044dd50009aba135744a004464c6405466ae700ac0a80a04d55cf280089baa00135742a00a66a02eeb8d5d0a802199aa80d80e90009aba150033335501b75c40026ae854008c07cd5d09aba2500223263202633573804e04c04826ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aab9e5001137540026ae854008c03cd5d09aba2500223263201833573803203002c202e264c6402e66ae712410350543500017135573ca00226ea80048d400488880088d40048800448c88c008dd6000990009aa811911999aab9f0012501f233501e30043574200460066ae880080488c8c8cccd5cd19b8735573aa004900011991091980080180118051aba150023005357426ae8940088c98c8048cd5ce00980900809aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa004900011991091980080180118099aba1500233500d012357426ae8940088c98c805ccd5ce00c00b80a89aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423025357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6403266ae7006806405c0580544d55cea80089baa00135742a00466a012eb8d5d09aba2500223263201333573802802602226ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab00132001355020223233335573e0044a03a466a03866442466002006004600c6aae754008c014d55cf280118021aba200301013574200224464646666ae68cdc3a800a400046a02a600a6ae84d55cf280191999ab9a3370ea00490011280a91931900819ab9c01101000e00d135573aa00226ea80048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900819ab9c01101000e00d00c00b135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900619ab9c00d00c00a135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c8028cd5ce00580500409baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c804ccd5ce00a00980880800780700680600589aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6401866ae700340300280244d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200933573801401200e00c26aae7540044dd500089119191999ab9a3370ea00290021091100091999ab9a3370ea00490011190911180180218031aba135573ca00846666ae68cdc3a801a400042444004464c6401466ae7002c02802001c0184d55cea80089baa0012323333573466e1d40052002201623333573466e1d40092000201623263200633573800e00c00800626aae74dd5000a4c2400292103505431003200135501122112253350011500e22133500f3004002335530061200100400112533500121010100e11222333550033212330012253350022100310010025004253353003001135006001150050011212230020031122001111222300330020012253350021001100a123750002640026aa0124422444a66a00226a00644002442666a00a440046008004666aa600e2400200a008002224400424424466002008006244a666a0042a666a002200c4200c4200c42a666a004200c42666ae68cdd78010008040039080390a999a801080310803909980300100090911180100211199ab9a3371e00400200800624400424400222446004002224646002002446600660040040021a300581d709c8e9da7f81e3ca90485f32ebefc98137c8ac260a072a00c4aaf142d011a0098968003d81859076a82025907655907620100003232323232323232323232323232332232323232322232325335320193333573466e1cd55cea80124000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd4050054d5d0a80619a80a00a9aba1500b33501401635742a014666aa030eb9405cd5d0a804999aa80c3ae501735742a01066a02803e6ae85401cccd54060081d69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd40a9d69aba15002302b357426ae8940088c98c80b4cd5ce01701681589aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a8153ad35742a00460566ae84d5d1280111931901699ab9c02e02d02b135573ca00226ea8004d5d09aba2500223263202933573805405204e26aae7940044dd50009aba1500533501475c6ae854010ccd540600708004d5d0a801999aa80c3ae200135742a004603c6ae84d5d1280111931901299ab9c026025023135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a004601c6ae84d5d1280111931900b99ab9c018017015101613263201633573892010350543500016135573ca00226ea800448c88c008dd6000990009aa80a911999aab9f0012500a233500930043574200460066ae880080508c8c8cccd5cd19b8735573aa004900011991091980080180118061aba150023005357426ae8940088c98c8050cd5ce00a80a00909aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa0049000119910919800801801180a9aba1500233500f014357426ae8940088c98c8064cd5ce00d00c80b89aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423212223002004357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6403666ae7007006c06406005c4d55cea80089baa00135742a00466a016eb8d5d09aba2500223263201533573802c02a02626ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab00132001355012223233335573e0044a010466a00e66442466002006004600c6aae754008c014d55cf280118021aba200301213574200222440042442446600200800624464646666ae68cdc3a800a40004642446004006600a6ae84d55cf280191999ab9a3370ea0049001109100091931900819ab9c01101000e00d135573aa00226ea80048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900819ab9c01101000e00d00c00b135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900619ab9c00d00c00a135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c8028cd5ce00580500409baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c804ccd5ce00a00980880800780700680600589aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6401866ae700340300280244d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200933573801401200e00c26aae7540044dd500089119191999ab9a3370ea00290021091100091999ab9a3370ea00490011190911180180218031aba135573ca00846666ae68cdc3a801a400042444004464c6401466ae7002c02802001c0184d55cea80089baa0012323333573466e1d40052002200723333573466e1d40092000212200123263200633573800e00c00800626aae74dd5000a4c2400292010350543100122002112323001001223300330020020011021a0006bfeda100818258200f34e81e6ffcf01b14358dad56866cd62e925135d16f915b40a93369202c1f8a5840e118e4cecf0fb21997f5f5b9bad06a854fbf158b08b8cebe58ceeaf9b85b73d1471fdfc789047ee02b0d49f9271b4545597c898b7960dba60c52f69b71298e0df5f6";
        var expectedSignedTxCbor = 
            "84a30081825820a8d2cd792a5d2f76666e748b0842bcdb518e47326f947c06fe6d71738da2f74c00018682581d607c40adaab5ef87c92a64032abf9fd59164a62e37aed1df80cca5f4881a336cca37a400581d709c8e9da7f81e3ca90485f32ebefc98137c8ac260a072a00c4aaf142d011a00989680028201d81842182a03d81859076a82025907655907620100003232323232323232323232323232332232323232322232325335320193333573466e1cd55cea80124000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd4050054d5d0a80619a80a00a9aba1500b33501401635742a014666aa030eb9405cd5d0a804999aa80c3ae501735742a01066a02803e6ae85401cccd54060081d69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd40a9d69aba15002302b357426ae8940088c98c80b4cd5ce01701681589aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a8153ad35742a00460566ae84d5d1280111931901699ab9c02e02d02b135573ca00226ea8004d5d09aba2500223263202933573805405204e26aae7940044dd50009aba1500533501475c6ae854010ccd540600708004d5d0a801999aa80c3ae200135742a004603c6ae84d5d1280111931901299ab9c026025023135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a004601c6ae84d5d1280111931900b99ab9c018017015101613263201633573892010350543500016135573ca00226ea800448c88c008dd6000990009aa80a911999aab9f0012500a233500930043574200460066ae880080508c8c8cccd5cd19b8735573aa004900011991091980080180118061aba150023005357426ae8940088c98c8050cd5ce00a80a00909aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa0049000119910919800801801180a9aba1500233500f014357426ae8940088c98c8064cd5ce00d00c80b89aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423212223002004357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6403666ae7007006c06406005c4d55cea80089baa00135742a00466a016eb8d5d09aba2500223263201533573802c02a02626ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab00132001355012223233335573e0044a010466a00e66442466002006004600c6aae754008c014d55cf280118021aba200301213574200222440042442446600200800624464646666ae68cdc3a800a40004642446004006600a6ae84d55cf280191999ab9a3370ea0049001109100091931900819ab9c01101000e00d135573aa00226ea80048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900819ab9c01101000e00d00c00b135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900619ab9c00d00c00a135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c8028cd5ce00580500409baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c804ccd5ce00a00980880800780700680600589aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6401866ae700340300280244d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200933573801401200e00c26aae7540044dd500089119191999ab9a3370ea00290021091100091999ab9a3370ea00490011190911180180218031aba135573ca00846666ae68cdc3a801a400042444004464c6401466ae7002c02802001c0184d55cea80089baa0012323333573466e1d40052002200723333573466e1d40092000212200123263200633573800e00c00800626aae74dd5000a4c240029201035054310012200211232300100122330033002002001182581d607c40adaab5ef87c92a64032abf9fd59164a62e37aed1df80cca5f4881a00989680a300581d70413c207fce1ba8c107175867519d3a8ccf38a9468f6f22a221974535011a00989680028201d81842182aa300581d608856d5d59beca8dd12361693b0ac9376e35e93efeb8771bd6896db41011a00a5558c03d8185908fd82025908f85908f5010000323233223232323322323232323322323232323232323232323232323232323232323232322223232533532323302132533533029001488100102a102b376600c660426a038666aa03a60462400246664002a04e002605066aa0584002664002a046902a19aa8159aa980d8900099aaa810004004991a80091111111111100628009a80e199aa80e98118900091999000a813800981419aa8161000999000a811a40a866aa0566aa60362400266aaa040010012646a002444444444444016a00226a002440046666ae68cdc39aab9d5002480008cc8848cc00400c008c8c8c8c8c8c8c8c8c8c8c8c8c8cccd5cd19b8735573aa018900011999999999999111111111110919999999999980080680600580500480400380300280200180119a80b80c1aba1500c33501701835742a01666a02e0326ae854028ccd5406dd7280d1aba150093335501b75ca0346ae854020cd405c080d5d0a803999aa80d810bad35742a00c6464646666ae68cdc39aab9d5002480008cc8848cc00400c008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a815bad35742a00460586ae84d5d1280111931901719ab9c02f02e02c135573ca00226ea8004d5d0a8011919191999ab9a3370e6aae754009200023322123300100300233502b75a6ae854008c0b0d5d09aba2500223263202e33573805e05c05826aae7940044dd50009aba135744a004464c6405466ae700ac0a80a04d55cf280089baa00135742a00a66a02eeb8d5d0a802199aa80d80e90009aba150033335501b75c40026ae854008c07cd5d09aba2500223263202633573804e04c04826ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aab9e5001137540026ae854008c03cd5d09aba2500223263201833573803203002c202e264c6402e66ae712410350543500017135573ca00226ea80048d400488880088d40048800448c88c008dd6000990009aa811911999aab9f0012501f233501e30043574200460066ae880080488c8c8cccd5cd19b8735573aa004900011991091980080180118051aba150023005357426ae8940088c98c8048cd5ce00980900809aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa004900011991091980080180118099aba1500233500d012357426ae8940088c98c805ccd5ce00c00b80a89aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423025357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6403266ae7006806405c0580544d55cea80089baa00135742a00466a012eb8d5d09aba2500223263201333573802802602226ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab00132001355020223233335573e0044a03a466a03866442466002006004600c6aae754008c014d55cf280118021aba200301013574200224464646666ae68cdc3a800a400046a02a600a6ae84d55cf280191999ab9a3370ea00490011280a91931900819ab9c01101000e00d135573aa00226ea80048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900819ab9c01101000e00d00c00b135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900619ab9c00d00c00a135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c8028cd5ce00580500409baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c804ccd5ce00a00980880800780700680600589aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6401866ae700340300280244d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200933573801401200e00c26aae7540044dd500089119191999ab9a3370ea00290021091100091999ab9a3370ea00490011190911180180218031aba135573ca00846666ae68cdc3a801a400042444004464c6401466ae7002c02802001c0184d55cea80089baa0012323333573466e1d40052002201623333573466e1d40092000201623263200633573800e00c00800626aae74dd5000a4c2400292103505431003200135501122112253350011500e22133500f3004002335530061200100400112533500121010100e11222333550033212330012253350022100310010025004253353003001135006001150050011212230020031122001111222300330020012253350021001100a123750002640026aa0124422444a66a00226a00644002442666a00a440046008004666aa600e2400200a008002224400424424466002008006244a666a0042a666a002200c4200c4200c42a666a004200c42666ae68cdd78010008040039080390a999a801080310803909980300100090911180100211199ab9a3371e00400200800624400424400222446004002224646002002446600660040040021a300581d709c8e9da7f81e3ca90485f32ebefc98137c8ac260a072a00c4aaf142d011a0098968003d81859076a82025907655907620100003232323232323232323232323232332232323232322232325335320193333573466e1cd55cea80124000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd4050054d5d0a80619a80a00a9aba1500b33501401635742a014666aa030eb9405cd5d0a804999aa80c3ae501735742a01066a02803e6ae85401cccd54060081d69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd40a9d69aba15002302b357426ae8940088c98c80b4cd5ce01701681589aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a8153ad35742a00460566ae84d5d1280111931901699ab9c02e02d02b135573ca00226ea8004d5d09aba2500223263202933573805405204e26aae7940044dd50009aba1500533501475c6ae854010ccd540600708004d5d0a801999aa80c3ae200135742a004603c6ae84d5d1280111931901299ab9c026025023135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a004601c6ae84d5d1280111931900b99ab9c018017015101613263201633573892010350543500016135573ca00226ea800448c88c008dd6000990009aa80a911999aab9f0012500a233500930043574200460066ae880080508c8c8cccd5cd19b8735573aa004900011991091980080180118061aba150023005357426ae8940088c98c8050cd5ce00a80a00909aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa0049000119910919800801801180a9aba1500233500f014357426ae8940088c98c8064cd5ce00d00c80b89aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423212223002004357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6403666ae7007006c06406005c4d55cea80089baa00135742a00466a016eb8d5d09aba2500223263201533573802c02a02626ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab00132001355012223233335573e0044a010466a00e66442466002006004600c6aae754008c014d55cf280118021aba200301213574200222440042442446600200800624464646666ae68cdc3a800a40004642446004006600a6ae84d55cf280191999ab9a3370ea0049001109100091931900819ab9c01101000e00d135573aa00226ea80048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900819ab9c01101000e00d00c00b135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900619ab9c00d00c00a135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c8028cd5ce00580500409baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c804ccd5ce00a00980880800780700680600589aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6401866ae700340300280244d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200933573801401200e00c26aae7540044dd500089119191999ab9a3370ea00290021091100091999ab9a3370ea00490011190911180180218031aba135573ca00846666ae68cdc3a801a400042444004464c6401466ae7002c02802001c0184d55cea80089baa0012323333573466e1d40052002200723333573466e1d40092000212200123263200633573800e00c00800626aae74dd5000a4c2400292010350543100122002112323001001223300330020020011021a0006bfeda100818258200f34e81e6ffcf01b14358dad56866cd62e925135d16f915b40a93369202c1f8a5840de0ac6922b1bd70ef3bec643b194c03249924b84a0ba1eb1bb837d5b6dca1b24e29c02312711313ce59f77bbfdbb99fb8d8459c9bcfbb9c91eae07a5e2d1950df5f6";

        var transactionBody = TransactionBodyBuilder.Create 
                //change and fee dictated by control
            .AddOutput(utxoAddress.ToAddress().GetBytes(), 862767671)
            .SetFee(442349)
                
            .AddInput(createTxHash.HexToByteArray(), createTxIndex)
            .AddOutput(readonlyAddress.ToAddress().GetBytes(), 10000000,
                datumOption: new DatumOption()
                {
                    Data = new PlutusDataInt() { Value = 42 }
                },
                scriptReference: new ScriptReference()
                {
                    PlutusV2Script = new PlutusV2Script { script = ((string)CBORObject.DecodeFromBytes(stakeScriptCbor.HexToByteArray())[1].DecodeValueByCborType()).HexToByteArray()  }
                })
            .AddOutput(utxoAddress.ToAddress().GetBytes(), 10000000)
            .AddOutput(plutusSpendingScriptAddress.ToAddress().GetBytes(), 10000000,
                datumOption: new DatumOption()
                {
                    Data = new PlutusDataInt() { Value = 42 }
                })
            .AddOutput(dummyAddress1.ToAddress().GetBytes(), 10835340,
                scriptReference: new ScriptReference()
                {
                    PlutusV2Script = new PlutusV2Script { script = ((string)CBORObject.DecodeFromBytes(redeemerScriptCbor.HexToByteArray()).DecodeValueByCborType()).HexToByteArray() }
                })
            .AddOutput(mintingRefScriptAddress.ToAddress().GetBytes(), 10000000,
                scriptReference: new ScriptReference()
                {
                    PlutusV2Script = new PlutusV2Script { script = ((string)CBORObject.DecodeFromBytes(mintingScriptCbor.HexToByteArray()).DecodeValueByCborType()).HexToByteArray() }
                })
            ;

        var skeyWithChainCodeBytes = Bech32.Decode(skey, out _, out _);
        var vkeyWithChainCodeBytes = Bech32.Decode(vkey, out _, out _);

        var skeyBytes = new byte[64];
        var vkeyBytes = new byte[32];
        
        Buffer.BlockCopy(skeyWithChainCodeBytes, 0, skeyBytes, 0, 64);
        Buffer.BlockCopy(vkeyWithChainCodeBytes, 0, vkeyBytes, 0, 32);

        var witness = TransactionWitnessSetBuilder.Create
            .AddVKeyWitness(new PublicKey(vkeyBytes, null), new PrivateKey(skeyBytes, null));

        var transaction = TransactionBuilder.Create
            .SetBody(transactionBody)
            .SetWitnesses(witness);
        
        //act
        var cborTransaction = transaction.Build().Serialize().ToStringHex();

        var testExpected = CBORObject.DecodeFromBytes(expectedSignedTxCbor.HexToByteArray());
        var testActual = CBORObject.DecodeFromBytes(cborTransaction.HexToByteArray());

        //assert
        Assert.Equal(expectedSignedTxCbor, cborTransaction);
    }

    private readonly string spendTxHash = "eb15dc2bf48cd92bb4217068119122673e4964371cbaeb6a1f06398b94cf8f63";
    private readonly uint spendTxIndexAda = 0;
    private readonly uint spendTxIndexReadonly = 1;    
    private readonly uint spendTxIndexPlutusLockedUtxo = 3;
    private readonly uint spendTxIndexPlutusRefScript = 4;
    private readonly uint spendTxIndexMintingRefScript = 5;
    private readonly string collateralTxHash = "c0a9b46de581b8d8bafea22b171500c6d82a157b4ab6f7b2be6d20395e4ecd4d";
    private readonly uint collateralTxIndex = 0;
    private readonly long collateral = 527973;
    private readonly long returnedCollateral = 4472027;
    private readonly string policyId = "9c8e9da7f81e3ca90485f32ebefc98137c8ac260a072a00c4aaf142d";
    private readonly string assetName = "4D696C6C6172436F696E";
    private readonly int mintQuantity = 5;
    private readonly string dummyAddress2 = "addr_test1vqmmd65u4uk6y7k5ukpt9v3ddxxs762s8x9jldvpm7ussgqwnpmq0";
    
    // cardano-cli transaction build \
    // --babbage-era \
    // --cardano-mode \
    // --testnet-magic 1 \
    // --change-address "addr_test1vp7yptd2khhc0jf2vspj40ul6kgkff3wx7hdrhuqejjlfzquzf422" \
    // --read-only-tx-in-reference "eb15dc2bf48cd92bb4217068119122673e4964371cbaeb6a1f06398b94cf8f63#1" \
    // --tx-in "eb15dc2bf48cd92bb4217068119122673e4964371cbaeb6a1f06398b94cf8f63#0" \
    // --tx-in-collateral "c0a9b46de581b8d8bafea22b171500c6d82a157b4ab6f7b2be6d20395e4ecd4d#0" \
    // --tx-total-collateral 527973 \
    // --tx-out-return-collateral "addr_test1vp7yptd2khhc0jf2vspj40ul6kgkff3wx7hdrhuqejjlfzquzf422+4472027" \
    // --out-file "test-alonzo-ref-script.body" \
    // --tx-in "eb15dc2bf48cd92bb4217068119122673e4964371cbaeb6a1f06398b94cf8f63#3" \
    // --spending-tx-in-reference "eb15dc2bf48cd92bb4217068119122673e4964371cbaeb6a1f06398b94cf8f63#4" \
    // --spending-plutus-script-v2 \
    // --spending-reference-tx-in-inline-datum-present \
    // --spending-reference-tx-in-redeemer-file "42.redeemer" \
    // --mint "5 9c8e9da7f81e3ca90485f32ebefc98137c8ac260a072a00c4aaf142d.4D696C6C6172436F696E" \
    // --mint-tx-in-reference "eb15dc2bf48cd92bb4217068119122673e4964371cbaeb6a1f06398b94cf8f63#5" \
    // --mint-plutus-script-v2 \
    // --mint-reference-tx-in-redeemer-file "42.redeemer" \
    // --policy-id "9c8e9da7f81e3ca90485f32ebefc98137c8ac260a072a00c4aaf142d" \
    // --tx-out "addr_test1vqmmd65u4uk6y7k5ukpt9v3ddxxs762s8x9jldvpm7ussgqwnpmq0+10000000 + 5 9c8e9da7f81e3ca90485f32ebefc98137c8ac260a072a00c4aaf142d.4D696C6C6172436F696E" \
    // --protocol-params-file "pparams.json"
    //
    // cardano-cli transaction sign \
    // --tx-body-file test-alonzo-ref-script.body \
    // --testnet-magic 1 \
    // --signing-key-file sKey.prv \
    // --out-file alonzo-ref-script.tx
    [Fact]
    public void CallReferenceScriptTest1()
    {
        // Cardano cli ordering
        // expectedSignTxCbor has a map type { 0: "", 1: "" } for a transaction output. Other libraries still use the array type for legacy outputs so the library has been updated to use those
        // var expectedSignedTxCbor = 
        //     "84a90082825820eb15dc2bf48cd92bb4217068119122673e4964371cbaeb6a1f06398b94cf8f6300825820eb15dc2bf48cd92bb4217068119122673e4964371cbaeb6a1f06398b94cf8f63030d81825820c0a9b46de581b8d8bafea22b171500c6d82a157b4ab6f7b2be6d20395e4ecd4d001283825820eb15dc2bf48cd92bb4217068119122673e4964371cbaeb6a1f06398b94cf8f6301825820eb15dc2bf48cd92bb4217068119122673e4964371cbaeb6a1f06398b94cf8f6304825820eb15dc2bf48cd92bb4217068119122673e4964371cbaeb6a1f06398b94cf8f63050182a200581d607c40adaab5ef87c92a64032abf9fd59164a62e37aed1df80cca5f488011a367b39b0a200581d6037b6ea9caf2da27ad4e582b2b22d698d0f6950398b2fb581dfb9082001821a00989680a1581c9c8e9da7f81e3ca90485f32ebefc98137c8ac260a072a00c4aaf142da14a4d696c6c6172436f696e0510a200581d607c40adaab5ef87c92a64032abf9fd59164a62e37aed1df80cca5f488011a00443cdb111a00080e65021a00055eee09a1581c9c8e9da7f81e3ca90485f32ebefc98137c8ac260a072a00c4aaf142da14a4d696c6c6172436f696e050b5820ad5bced580b5a94bc1241213a906e57a923e4826f428c2bb83ae29af8fc93a14a200818258200f34e81e6ffcf01b14358dad56866cd62e925135d16f915b40a93369202c1f8a58409b7b9278c4c744db6f1bd340afa8e4277313f673609f37be4d753459d9b97cad2d96f09fb0b7893ac3cde3fb4dc924fce3711e40e5c70c86f6831efed08b45040582840001182a821a0011217e1a1491ded6840100182a821a000e3e721a1181c132f5f6";

        // CardanoSharp Ordering
        var expectedSignedTxCbor =
               "84a90082825820eb15dc2bf48cd92bb4217068119122673e4964371cbaeb6a1f06398b94cf8f6300825820eb15dc2bf48cd92bb4217068119122673e4964371cbaeb6a1f06398b94cf8f6303018282581d607c40adaab5ef87c92a64032abf9fd59164a62e37aed1df80cca5f4881a367b39b082581d6037b6ea9caf2da27ad4e582b2b22d698d0f6950398b2fb581dfb90820821a00989680a1581c9c8e9da7f81e3ca90485f32ebefc98137c8ac260a072a00c4aaf142da14a4d696c6c6172436f696e05021a00055eee09a1581c9c8e9da7f81e3ca90485f32ebefc98137c8ac260a072a00c4aaf142da14a4d696c6c6172436f696e050b5820ad5bced580b5a94bc1241213a906e57a923e4826f428c2bb83ae29af8fc93a140d81825820c0a9b46de581b8d8bafea22b171500c6d82a157b4ab6f7b2be6d20395e4ecd4d001082581d607c40adaab5ef87c92a64032abf9fd59164a62e37aed1df80cca5f4881a00443cdb111a00080e651283825820eb15dc2bf48cd92bb4217068119122673e4964371cbaeb6a1f06398b94cf8f6301825820eb15dc2bf48cd92bb4217068119122673e4964371cbaeb6a1f06398b94cf8f6304825820eb15dc2bf48cd92bb4217068119122673e4964371cbaeb6a1f06398b94cf8f6305a200818258200f34e81e6ffcf01b14358dad56866cd62e925135d16f915b40a93369202c1f8a584092e0be855812fb5cbf9024d4465d424d256a1a3aa92c84e6d6c42df933d03963dba312566e70a7bf0da53d3054283bbd6a8706142cf8f385d38492b834c071010582840001182a821a0011217e1a1491ded6840100182a821a000e3e721a1181c132f5f6";

        ITokenBundleBuilder mint = TokenBundleBuilder.Create.AddToken(policyId.HexToByteArray(), assetName.HexToByteArray(), (long)mintQuantity);

        // ExUnits Require Protocol Parameter Calculates from a Cardano Node
        RedeemerBuilder spendRedeemerBuilder = (RedeemerBuilder)RedeemerBuilder.Create
            .SetTag(RedeemerTag.Spend)
            .SetIndex(spendTxIndexReadonly)
            .SetPlutusData(new PlutusDataInt { Value = 42 })
            .SetExUnits(new ExUnits { Mem = 1122686, Steps = 345104086 } );

        RedeemerBuilder mintRedeemerBuilder = (RedeemerBuilder)RedeemerBuilder.Create
            .SetTag(RedeemerTag.Mint)
            .SetIndex(spendTxIndexAda)
            .SetPlutusData(new PlutusDataInt { Value = 42 })
            .SetExUnits(new ExUnits { Mem = 933490, Steps = 293716274 } );
        
        var transactionBody = TransactionBodyBuilder.Create
            .AddOutput(new Address(utxoAddress), 914045360)
            .AddInput(spendTxHash.HexToByteArray(), spendTxIndexAda)
            .AddInput(spendTxHash.HexToByteArray(), spendTxIndexPlutusLockedUtxo)
            .AddOutput(new Address(dummyAddress2), (ulong)lovelace1, mint)
            .SetFee(351982)
            .SetMint(mint)
            .SetScriptDataHash(new List<Redeemer> { spendRedeemerBuilder.Build(), mintRedeemerBuilder.Build() }, null, CostModelUtility.PlutusV2CostModel.Serialize())
            .AddCollateralInput(collateralTxHash.HexToByteArray(), collateralTxIndex)
            .SetTotalCollateral((ulong)collateral)
            .SetCollateralOutput(new Address(utxoAddress), (ulong)returnedCollateral)
            .AddReferenceInput(spendTxHash.HexToByteArray(), spendTxIndexReadonly)
            .AddReferenceInput(spendTxHash.HexToByteArray(), spendTxIndexPlutusRefScript)
            .AddReferenceInput(spendTxHash.HexToByteArray(), spendTxIndexMintingRefScript);       

        var skeyWithChainCodeBytes = Bech32.Decode(skey, out _, out _);
        var vkeyWithChainCodeBytes = Bech32.Decode(vkey, out _, out _);

        var skeyBytes = new byte[64];
        var vkeyBytes = new byte[32];
        
        Buffer.BlockCopy(skeyWithChainCodeBytes, 0, skeyBytes, 0, 64);
        Buffer.BlockCopy(vkeyWithChainCodeBytes, 0, vkeyBytes, 0, 32);        
        
        var witness = TransactionWitnessSetBuilder.Create   
            .AddVKeyWitness(new PublicKey(vkeyBytes, null), new PrivateKey(skeyBytes, null))  
            .AddRedeemer(spendRedeemerBuilder)
            .AddRedeemer(mintRedeemerBuilder);

        var transaction = TransactionBuilder.Create
            .SetBody(transactionBody)
            .SetWitnesses(witness);
        
        //act
        var cborTransaction = transaction.Build().Serialize().ToStringHex();

        var testExpected = CBORObject.DecodeFromBytes(expectedSignedTxCbor.HexToByteArray());
        var testActual = CBORObject.DecodeFromBytes(cborTransaction.HexToByteArray());

        //assert
        Assert.Equal(expectedSignedTxCbor, cborTransaction);
    }
}